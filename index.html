<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ভাইরাল ভিডিও সার্ভার</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0} 
        body{font-family:'Arial',sans-serif;background:#EAECEF;color:#333} 
        header{background:#1a1a2e; color:#fff; display: flex; align-items: center; justify-content: space-between; gap: 15px; padding:10px 14px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);} 
        .global-menu-btn{position:static; transform:none; font-size:26px; background: none; border: none; color: white; cursor: pointer;} 
        #searchInput { flex-grow: 1; padding: 10px 15px; border: 1px solid #4a4a5e; background-color: #2a2a3e; color: #fff; border-radius: 20px; font-size: 15px; outline: none;} 
        #searchInput::placeholder { color: #aaa; } 
        .floater-ticker {background: #d0eaff; color: #1a1a2e; padding: 10px 0; overflow: hidden; white-space: nowrap;border-bottom: 2px solid #a0caff; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);} 
        .floater-content {display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite;font-weight: bold; font-size: 15px;} 
        @keyframes marquee {0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); }} 
        .tabs{display:flex;overflow-x:auto;padding:10px 5px;background:#fff;border-bottom:2px solid #eee;box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);} 
        .tabs button{padding:10px 16px; border:none; background:#f0f0f5; margin:0 4px;cursor:pointer; border-radius:20px; font-weight:bold; color:#555;transition: background 0.3s, color 0.3s; flex-shrink: 0;} 
        .tabs button.active{background:#e60023; color:#fff; box-shadow: 0 2px 8px rgba(230, 0, 35, 0.4);} 
        .container {padding: 10px 0;} 
        .grid {display: grid;grid-template-columns: 1fr;gap: 30px;padding: 0 20px;} 
        .card{background:#fff; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.1); overflow:hidden; transition: transform 0.3s, box-shadow 0.3s; position: relative;} 
        .card-image-wrapper{position: relative; height: 275px; overflow: hidden;} 
        .card-image-wrapper img{width:100%; height:100%; object-fit:cover; display:block;} 
        .card-title { font-size: 18px; font-weight: bold; color: #1a1a2e; margin-bottom: 8px; padding: 10px 15px 0 15px; white-space: normal; display: -webkit-box;-webkit-line-clamp: 2; -webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis; } 
        .card-body{padding:0 15px 15px 15px; padding-top: 0;} 
        .card-desc{font-size:14px;color:#777;margin-bottom:15px; font-weight: 500;display: flex;justify-content: space-between; align-items: center;} 
        .unlock-btn,.watch-btn{width:100%; padding:12px; font-size:16px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition: background 0.3s, transform 0.2s;} 
        .unlock-btn{background: linear-gradient(to right, #6a11cb, #2575fc);color:#fff;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);} 
        .unlock-btn:hover {transform: translateY(-2px);box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);} 
        .watch-btn{background:#e60023; color:#fff;} 
        .sidebar{position:fixed; top:0; left:-300px; width:280px; height:100%; background:#fff; z-index:1100; padding:0; display: flex; flex-direction: column; box-shadow: 4px 0 20px rgba(0,0,0,0.4); transition:left 0.3s ease-in-out;} 
        .sidebar.active{left:0;} 
        .sidebar-header{ font-size: 20px; font-weight: bold; color: #fff; background: #333; padding: 15px 25px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; } 
        .sidebar-close-btn { background: none; border: none; color: #e60023; font-size: 30px; font-weight: 900; cursor: pointer; padding: 0; line-height: 1; } 
        .sidebar-links {padding: 20px 15px;} 
        .sidebar-links a { display: block; padding: 12px 15px; color: #0056b3; text-decoration: none; margin-bottom: 10px; border-radius: 20px; font-weight: bold; transition: all 0.2s ease-in-out; background: #eaf6ff; text-align: center; border: 1px solid #cce7ff; } 
        .sidebar-links a:hover { background: #d0eaff; color: #003a75; transform: scale(1.03); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); } 
        .sidebar-links a.active-link { background: #e60023 !important; color: #fff !important; box-shadow: 0 2px 5px rgba(230, 0, 35, 0.3); transform: none !important; } 
        .sidebar-follow-header { background: #333; color: #fff; font-size: 16px; font-weight: bold; padding: 10px 25px; margin-top: 15px; } 
        .sidebar-follow-links {padding: 15px; padding-bottom: 0;} 
        .sidebar-follow-links a { background: #fff8e1; color: #c58900; border: 1px solid #ffecb3; } 
        .sidebar-follow-links a:hover { background: #ffecb3; color: #8c5d00; } 
        .sidebar-footer { padding: 15px; border-top: 1px solid #eee; margin-top: auto; } 
        .sidebar-back-btn {width: 100%; padding: 10px; background: #e60023; color: #fff;border: none; border-radius: 8px; font-weight: bold; cursor: pointer;transition: background 0.2s;} 
        .sidebar-back-btn:hover { background: #cc001f; } 
        .overlay {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.5);z-index: 1050;display: none;} 
        .modal{position:fixed;top:0;left:0;width:100%;height:100%; background:rgba(0,0,0,0.7); display:none;align-items:center; justify-content:center; z-index:1000; opacity: 0; transition:opacity 0.3s;} 
        #termsModal.active{z-index: 9999 !important; opacity: 1; display: flex;} 
        .modal.active{opacity: 1; display: flex;} 
        .modal-content{background:#fff; border-radius:15px; max-width:400px; width:90%; padding:30px; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform:scale(0.8); transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; max-height: 80vh; overflow-y: auto;} 
        .modal.active .modal-content{transform:scale(1);} 
        #termsModal .modal-content h2, #rulesModal .modal-content h2 {color: #e60023;} 
        .modal-content button {padding: 12px 25px; border: none;border-radius: 8px;font-weight: bold;cursor: pointer;transition: background 0.3s, transform 0.2s;margin-top: 20px; font-size: 16px;min-width: 120px;} 
        .close-btn {background: #f0f0f5;color: #555;margin-right: 15px;} 
        .close-btn:hover {background: #ddd;} 
        .buy-btn, .accept-btn, .ok-btn {background: #e60023;color: #fff;} 
        .buy-btn:hover, .accept-btn:hover, .ok-btn:hover {background: #cc001f;} 
        #termsModal .modal-content p, #rulesModal .modal-content p {text-align: justify; font-size: 14px; color: #333; line-height: 1.6; margin-bottom: 15px;} 
        .pagination {display: flex;flex-wrap: wrap;justify-content: center;padding: 20px 0;margin-top: 10px;} 
        .page-btn {padding: 8px 14px;margin: 0 5px;border: 1px solid #ddd;background: #fff;color: #555;border-radius: 6px;cursor: pointer;font-weight: bold;transition: background 0.2s, color 0.2s;} 
        .page-btn.active {background: #e60023;color: #fff;border-color: #e60023;} 
        .page-btn:hover:not(.active) {background: #f0f0f5;} 
        .pagination-footer {text-align: center;margin: -10px 0 20px 0;font-weight: bold;color: #e60023;} 
        .skeleton-card {background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.05); padding: 0; overflow: hidden;} 
        .skeleton-image {height: 240px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite;} 
        .skeleton-text {height: 14px; margin-bottom: 8px; border-radius: 4px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite;} 
        .skeleton-text.short { width: 60%; } 
        .skeleton-text.button { height: 40px; margin-top: 15px; } 
        @keyframes loading {0% { background-position: 200% 0; } 100% { background-position: -200% 0; }} 
        .skeleton-card .card-body { padding: 15px; } 
        .progress-bar-container {margin-bottom: 20px;padding: 0 10px;} 
        .progress-header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 8px;} 
        .progress-text {font-size: 15px;font-weight: bold;color: #1a1a2e;} 
        .rules-menu-btn {background: none;border: none;font-size: 24px;color: #555;cursor: pointer;padding: 0 5px;font-weight: bold;} 
        .progress-bar-wrapper {width: 100%;background: #fff;border-radius: 20px;height: 14px;overflow: hidden;box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);} 
        .progress-bar-fill {height: 100%;background: linear-gradient(to right, #8000ff, #e60023);border-radius: 20px;transition: width 0.5s ease-in-out;} 
        #unlockSuccessModal .modal-content {border-top: 5px solid #28a745;} 
        #unlockSuccessModal .modal-content h2 {color: #28a745;font-size: 24px;} 
        #unlockSuccessModal .modal-content p {font-size: 16px;color: #333;margin-top: 15px;margin-bottom: 25px;}

        /* Loader specific styles */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            transition: opacity 0.5s ease;
        }

        .loader-spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #e60023; /* Red */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="page-loader" id="pageLoader">
        <div class="loader-spinner"></div>
    </div>

    <header>
        <button id="globalMenuBtn" class="global-menu-btn">≡</button>
        <input type="search" id="searchInput" placeholder="ভিডিও খুঁজুন...">
    </header>
    <div class="floater-ticker" id="floaterTicker" style="display: none;"><div class="floater-content" id="floaterContent">লোড হচ্ছে...</div></div>
    <div class="tabs" id="tabs" style="display: none;"></div>
    <div class="container" id="mainContent" style="display: none;">
        <div class="progress-bar-container">
            <div class="progress-header">
                <span id="progressBarText" class="progress-text"></span>
                <button id="rulesMenuBtn" class="rules-menu-btn" onclick="openRulesModal()">&#8942;</button>
            </div>
            <div class="progress-bar-wrapper"><div id="progressBarFill" class="progress-bar-fill" style="width: 0%;"></div></div>
        </div>
        <div id="list" class="grid"></div>
        <div id="pagination" class="pagination"></div>
        <div id="paginationFooterText" class="pagination-footer"></div>
    </div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header"><span>Main Menu</span><button class="sidebar-close-btn" onclick="closeSidebar()">×</button></div>
        <div class="sidebar-links">
            <a href="#" id="premiumLink" onclick="openPremiumModal(this)">Premium Offer</a>
            <a href="#" id="privacyLink" onclick="openPrivacyModal(this)">Privacy Policy</a>
            <a href="#" id="aboutLink" onclick="openAboutModal(this)">About</a>
            <a href="https://t.me/Rx_Admin9" target="_blank" id="contactLink">📞 Contact Us</a>
        </div>
        <div class="sidebar-follow-header">Follow Our Community</div>
        <div class="sidebar-links sidebar-follow-links">
            <a href="https://t.me/+L4ax5AFi6MNlOWM1" target="_blank" id="telegramLink">Telegram</a>
            <a href="https://otieu.com/4/9873659" target="_blank" id="website18Link">🔞 18+ Website</a>
            <a href="https://yourwebsite.com" target="_blank" id="youtubeLink">Youtube</a>
        </div>
        <div class="sidebar-footer"><button class="sidebar-back-btn" onclick="closeSidebar()">পেছনে যান</button></div>
    </div>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    <div class="modal" id="premiumModal"> <div class="modal-content"> <h2>প্রিমিয়াম সুবিধা</h2> <p style="text-align: left; font-size: 16px; margin-bottom: 25px; color: #1a1a2e; line-height: 1.6;"> <strong style="color: #8000ff;">প্রিমিয়াম প্যাকেজে যা আছে:</strong> <ul style="list-style: none; padding: 10px 0 0 15px;"> <li style="margin-bottom: 8px; border-bottom: 1px solid #eee;">৩০০০+ ভাইরাল ভিডিও</li> <li style="margin-bottom: 8px; border-bottom: 1px solid #eee;">প্রতিদিন ৫০+ নতুন আপলোড ও HD কনটেন্ট</li> <li style="margin-bottom: 8px; border-bottom: 1px solid #eee;">বিজ্ঞাপন বিহীন অভিজ্ঞতা </li> <li style="margin-bottom: 8px;">বাছাই করা সকল ক্যাটাগরীর কন্টেন্ট</li> </ul> </p> <button class="close-btn" onclick="closePremiumModal()">বন্ধ</button> <button class="buy-btn" onclick="window.open('https://t.me/Rx_Admin9', '_blank')">কিনুন</button> </div> </div>
    <div class="modal" id="privacyModal"> <div class="modal-content"> <h2>প্রাইভেসি পলিসি</h2> <p>আমরা ব্যবহারকারীর ব্যক্তিগত তথ্য গুরুত্ব দিয়ে রাখি। সাইটে কুকি/লোকালস্টোরেজ ব্যবহার করা হতে পারে — শুধুমাত্র সাইটের কার্যকারিতা নিশ্চিত করার জন্য।</p> <button class="close-btn" onclick="closePrivacyModal()">বন্ধ</button> </div> </div>
    <div class="modal" id="aboutModal"> <div class="modal-content"> <h2>আমাদের সম্পর্কে</h2> <p style="text-align: justify; font-size: 14px; color: #555; line-height: 1.6;"> <strong>Viral Video Zone</strong> হল একটি ১৮+ ভাইরাল ভিডিও শেয়ার প্ল্যাটফর্ম। এখানে আপনি বিভিন্ন ক্যাটাগরির ভিডিও দেখতে পারবেন, প্রিমিয়াম প্যাকেজে অতিরিক্ত সুবিধা পাবেন, এবং নিয়মিত নতুন কনটেন্ট আপলোড করা হবে। সাইটটি ব্যবহার করার আগে টার্মস অ্যান্ড কন্ডিশন মেনে চলুন। </p> <button class="close-btn" onclick="closeAboutModal()">বন্ধ</button> </div> </div>
    <div class="modal" id="termsModal"> <div class="modal-content"> <h2>শর্তাবলী ও নীতিমালা</h2> <div style="max-height: 300px; overflow-y: auto; padding-right: 10px; padding-top: 10px;"> <p>১. ব্যবহারকারীরা সাইটে পোস্ট করা কনটেন্ট কপি বা ডাউনলোড করার আগে কপিরাইট নীতিমালা মেনে চলবে।</p> <p>২. সাইট ব্যবহারে কোনো অবৈধ কার্যকলাপে অংশগ্রহণ করা যাবে না। নিয়ম ভঙ্গ করলে অ্যাক্সেস ব্লক করা যেতে পারে।</p> <p>৩. প্রিমিয়াম সার্ভিস ফেরত নীতিমালা ও ব্যবহার শর্ত প্রযোজ্য। বিস্তারিত পড়ুন এবং সম্মতি দিন।</p> <p>৪. আমরা লোকাল স্টোরেজ ব্যবহার করে ব্যবহারকারীর আনলক স্টেট মেইনটেইন করি। প্রয়োজনে সেটি রিসেট হবে।</p> </div> <button class="accept-btn" onclick="acceptTermsAndEnterSite()">আমি গ্রহণ করছি</button> </div> </div>
    <div class="modal" id="rulesModal"> <div class="modal-content"> <h2>নিয়মাবলী</h2> <p id="rules-text">লোড হচ্ছে...</p> <button class="close-btn" onclick="closeRulesModal()">বন্ধ</button> </div> </div>
    <div class="modal" id="unlockSuccessModal"> <div class="modal-content"> <h2>অভিনন্দন!</h2> <p>আপনি ২৪ ঘন্টার জন্য সকল ভিডিও আনলক করেছেন, তাই এখন সকল ভিডিও বিজ্ঞাপন ছাড়া উপভোগ করুন।</p> <button class="ok-btn" onclick="closeUnlockSuccessModal()">ঠিক আছে</button> </div> </div>
    
    <!-- Monetag SDK script - will be dynamically loaded if zone_id is present -->
    <script id="ad-sdk-script"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDPG1QkQHZ2ceAt3QDjpUSSboiAN1HGY5s",
          authDomain: "viral-video-browser.firebaseapp.com",
          databaseURL: "https://viral-video-browser-default-rtdb.firebaseio.com",
          projectId: "viral-video-browser",
          storageBucket: "viral-video-browser.firebasestorage.app",
          messagingSenderId: "49241474813",
          appId: "1:49241474813:web:6070d550377953776ce094",
          measurementId: "G-0XL8NNC54W"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const VIDEOS_PER_PAGE = 10;
        let activeCategory = "", currentPage = 1, allVideosData = {}, updateInterval;
        const GLOBAL_UNLOCK_KEY = 'global_unlock_until', DAILY_UNLOCK_COUNT_KEY = 'daily_unlock_count';
        let DAILY_UNLOCK_LIMIT = 15;
        const UNLOCK_DURATION = 24 * 60 * 60 * 1000;
        // const AD_WATCH_DURATION = 15000; // 15 seconds (15 seconds) - এই লাইনটি মুছে ফেলা হয়েছে বা মন্তব্য করা হয়েছে

        document.addEventListener("DOMContentLoaded", () => {
            const pageLoader = document.getElementById('pageLoader');
            pageLoader.style.opacity = '1';

            document.getElementById("list").innerHTML = createSkeletonLoader(VIDEOS_PER_PAGE);
            document.getElementById('globalMenuBtn').addEventListener('click', openSidebar);

            db.ref().on('value', (snapshot) => {
                const data = snapshot.val() || {};
                
                if (data.videos) {
                    allVideosData = {};
                    for (const category in data.videos) {
                        if(data.videos[category] && typeof data.videos[category] === 'object'){
                           // filter out placeholder and null entries
                           const validVideos = Object.values(data.videos[category]).filter(v => v !== true && v !== false && v !== null);
                           allVideosData[category] = validVideos;
                        }
                    }
                }

                if (data.settings) {
                    const settings = data.settings;
                    document.getElementById('floaterContent').textContent = settings.live_text || 'Welcome to our video server!';
                    
                    const adScript = document.getElementById('ad-sdk-script');
                    if(adScript && settings.zone_id && settings.zone_id.trim() !== '') {
                        adScript.src = `//libtl.com/sdk.js`;
                        adScript.setAttribute('data-zone', settings.zone_id);
                        adScript.setAttribute('data-sdk', `show_${settings.zone_id}`);
                        adScript.defer = true;
                    } else if (adScript) {
                        adScript.removeAttribute('src'); // Ensure script is not loaded if no zone_id
                        adScript.removeAttribute('data-zone');
                        adScript.removeAttribute('data-sdk');
                        // Optionally remove any dynamically added monetag script if needed
                        const existingMonetag = document.querySelector('script[data-monetag="true"]');
                        if (existingMonetag) existingMonetag.remove();
                    }

                    DAILY_UNLOCK_LIMIT = settings.unlock_count || 15;
                    // এখানে rulesText থেকে ১৫ সেকেন্ডের শর্তটি বাদ দেওয়া হয়েছে
                    const rulesText = (settings.rules_text || `আপনি যদি ${DAILY_UNLOCK_LIMIT} টি ভিডিও দেখেন তাহলে আপনি পরবর্তী ২৪ ঘন্টার জন্য সকল ভিডিও বিজ্ঞাপন বিহীন উপভোগ করতে পারবেন।`);
                    document.getElementById('rules-text').innerText = rulesText;
                }

                // Menu Links Updater
                if (data.menu_links) {
                    const links = data.menu_links;
                    document.getElementById('contactLink').href = links.contact_us || '#';
                    document.getElementById('telegramLink').href = links.telegram || '#';
                    document.getElementById('website18Link').href = links.website18 || '#';
                    document.getElementById('youtubeLink').href = links.youtube || '#';
                }

                showTermsModal();
                if(localStorage.getItem('is_a_user') !== 'true'){
                    localStorage.setItem('is_a_user', 'true');
                    db.ref('analytics/total_users').transaction(c => (c || 0) + 1);
                }
                
                // Hide loader once data is loaded and terms are handled
                pageLoader.style.opacity = '0';
                setTimeout(() => { pageLoader.style.display = 'none'; }, 500);

            }, (error) => {
                document.getElementById("list").innerHTML = '<p style="text-align:center; color: red;">ডেটাবেজ থেকে তথ্য লোড করা সম্ভব হয়নি।</p>';
                console.error("Firebase data load error:", error);
                pageLoader.style.opacity = '0';
                setTimeout(() => { pageLoader.style.display = 'none'; }, 500);
            });
            document.getElementById('searchInput').addEventListener('input', handleSearch);
        });

        const getState = l => { 
            try { 
                const r = localStorage.getItem('unlock_' + encodeURIComponent(l)); 
                if (!r) return { unlockedUntil: 0 }; 
                const o = JSON.parse(r); 
                return (o.unlockedUntil && Date.now() > o.unlockedUntil) ? { unlockedUntil: 0 } : o; 
            } catch (e) { 
                console.error("Error parsing unlock state:", e);
                return { unlockedUntil: 0 }; 
            } 
        };
        const setState = (l, s) => localStorage.setItem('unlock_' + encodeURIComponent(l), JSON.stringify(s));
        const isGloballyUnlocked = () => { const u = localStorage.getItem(GLOBAL_UNLOCK_KEY); return u && Date.now() < parseInt(u); };
        const getDailyCount = () => { 
            const r = localStorage.getItem(DAILY_UNLOCK_COUNT_KEY); 
            if (!r) return { count: 0, date: new Date().toDateString() }; 
            const o = JSON.parse(r); 
            return o.date !== new Date().toDateString() ? { count: 0, date: new Date().toDateString() } : o; 
        };
        
        function incrementDailyCount() {
            if (isGloballyUnlocked()) return;
            let state = getDailyCount(); 
            state.count++; 
            state.date = new Date().toDateString();
            localStorage.setItem(DAILY_UNLOCK_COUNT_KEY, JSON.stringify(state));
            updateProgressBar();
            if (state.count >= DAILY_UNLOCK_LIMIT) {
                localStorage.setItem(GLOBAL_UNLOCK_KEY, Date.now() + UNLOCK_DURATION);
                setTimeout(() => { openUnlockSuccessModal(); switchTab(activeCategory, currentPage); }, 100);
            }
        }

        const openModal = (id, el=null) => { if(el)setActiveLink(el); closeSidebar(); document.getElementById(id).classList.add("active"); };
        const closeModal = (id, linkId=null) => { document.getElementById(id).classList.remove("active"); if(linkId) {const el=document.getElementById(linkId); if(el) el.classList.remove('active-link');} };
        const openSidebar = () => { document.getElementById("sidebar").classList.add("active"); document.getElementById("overlay").style.display = 'block'; };
        const closeSidebar = () => { document.getElementById("sidebar").classList.remove("active"); document.getElementById("overlay").style.display = 'none'; };
        const setActiveLink = (el=null) => { document.querySelectorAll('.sidebar-links a').forEach(a => a.classList.remove('active-link')); if (el) el.classList.add('active-link'); };
        const openPremiumModal=(e)=>openModal("premiumModal",e), closePremiumModal=()=>closeModal("premiumModal","premiumLink");
        const openPrivacyModal=(e)=>openModal("privacyModal",e), closePrivacyModal=()=>closeModal("privacyModal","privacyLink");
        const openAboutModal=(e)=>openModal("aboutModal",e), closeAboutModal=()=>closeModal("aboutModal","aboutLink");
        const openRulesModal=()=>openModal("rulesModal"), closeRulesModal=()=>closeModal("rulesModal");
        const openUnlockSuccessModal=()=>openModal("unlockSuccessModal"), closeUnlockSuccessModal=()=>closeModal("unlockSuccessModal");
        
        const showTermsModal = () => localStorage.getItem('terms_accepted') === 'true' ? startSite() : (document.getElementById("termsModal").classList.add("active"), document.body.style.overflow = 'hidden');
        const acceptTermsAndEnterSite = () => { localStorage.setItem('terms_accepted', 'true'); closeModal("termsModal"); startSite(); };
        
        function startSite() {
            document.body.style.overflow = 'auto';
            ['floaterTicker', 'tabs', 'mainContent'].forEach(id => document.getElementById(id).style.display = id === 'mainContent' ? 'block' : (id === 'floaterTicker' ? 'block' : 'flex'));
            updateProgressBar(); 
            loadCategoriesAndTabs(); 
            if(updateInterval) clearInterval(updateInterval); 
            updateInterval = setInterval(updateAllCardTimes, 60000);
        }

        function loadCategoriesAndTabs() {
            const tabsDiv = document.getElementById("tabs"); tabsDiv.innerHTML = '';
            let categories = ["All", ...Object.keys(allVideosData)];
            categories.forEach(cat => {
                const btn = document.createElement("button"); 
                btn.innerText = cat; 
                btn.onclick = () => switchTab(cat); 
                tabsDiv.appendChild(btn);
            });
            if (categories.length > 1) switchTab(categories[0]);
            else document.getElementById("list").innerHTML = '<p style="text-align:center; padding: 20px; font-weight: bold;">কোনো ভিডিও খুঁজে পাওয়া যায়নি।</p>';
        }

        function switchTab(cat, page = 1) {
            document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
            [...document.querySelectorAll(".tabs button")].find(b => b.innerText === cat)?.classList.add("active");
            activeCategory = cat; currentPage = page; renderList(cat, currentPage);
        }

        function handleSearch(event) {
            const query = event.target.value.toLowerCase().trim();
            if (!query) { switchTab(activeCategory, currentPage); return; }
            let filtered = [].concat(...Object.values(allVideosData)).filter(v => v.title && v.title.toLowerCase().includes(query));
            document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
            document.getElementById('pagination').innerHTML = ""; 
            document.getElementById('paginationFooterText').innerText = "";
            renderGrid(filtered);
        }

        async function showAd() {
            const adScript = document.getElementById('ad-sdk-script');
            const zoneId = adScript.getAttribute('data-zone');
            
            // If zoneId is not set or empty, directly return true (unlock video) without showing any alert
            if (!zoneId || zoneId.trim() === '') {
                return true; 
            }

            const adFunc = window[`show_${zoneId}`];
            if (typeof adFunc === "function") {
                let adWindow = null;
                const originalOpen = window.open;
                let adOpenedSuccessfully = false;

                // Temporarily override window.open to track if a new window is opened by the ad SDK
                window.open = function(url, name, features) {
                    const newWindow = originalOpen.apply(this, arguments);
                    setTimeout(() => { // Give a moment for the window to be properly set
                        if (newWindow && !newWindow.closed && typeof newWindow.closed !== 'undefined') {
                            adWindow = newWindow;
                            adOpenedSuccessfully = true;
                        }
                    }, 100); 
                    return newWindow;
                };

                try {
                    await adFunc(); // Attempt to show the ad
                    
                    // Give some time for the ad window to actually open and be detected
                    await new Promise(resolve => setTimeout(resolve, 1000)); 

                    // Restore original window.open immediately after adFunc is called.
                    window.open = originalOpen;

                    // If ad window was never opened or immediately closed/blocked, return false silently
                    if (!adOpenedSuccessfully || adWindow === null || adWindow.closed || typeof adWindow.closed === 'undefined') {
                        // No alert shown here, just fail silently.
                        return false; 
                    }
                    
                    // If ad opened successfully, assume it's watched and unlock.
                    // No more waiting for AD_WATCH_DURATION
                    const today = new Date().toISOString().slice(0, 10);
                    db.ref('analytics/total_ad_clicks').transaction(c => (c || 0) + 1);
                    db.ref(`analytics/daily_ad_clicks/${today}`).transaction(c => (c || 0) + 1);
                    return true; // Ad opened successfully, unlock video
                    
                } catch (e) { 
                    console.error("Ad error:", e); 
                    window.open = originalOpen; // Ensure original window.open is restored on error
                    // No alert shown here, just fail silently.
                    return false; 
                }
            } else { 
                // adFunc not found, likely SDK not loaded or zoneId is wrong. Silently allow unlock.
                return true; 
            }
        }

        const timeAgo = t => { if (!t) return 'কিছুক্ষণ আগে'; const n = new Date(), d = Math.floor((n - new Date(t)) / 1000), s = Math.floor(d / 86400); if (s > 0) return `${s} দিন আগে`; const h = Math.floor(d / 3600); if (h > 0) return `${h} ঘন্টা আগে`; const m = Math.floor(d / 60); return m > 0 ? `${m} মিনিট আগে` : `${d} সেকেন্ড আগে`; };
        const updateAllCardTimes = () => document.querySelectorAll('.upload-time-span').forEach(s => s.innerText = `আপলোড: ${timeAgo(s.dataset.uploadTime)}`);
        
        function createSkeletonLoader(count) { let h = ''; for (let i = 0; i < count; i++) h += `<div class="skeleton-card"><div class="skeleton-image"></div><div class="card-body"><div class="skeleton-text"></div><div class="skeleton-text short"></div><div class="skeleton-text button"></div></div></div>`; return h; }
        
        function renderGrid(data) {
            const listDiv = document.getElementById("list"); listDiv.innerHTML = "";
            if (!data || data.length === 0) { listDiv.innerHTML = '<p style="text-align:center; padding: 20px; font-weight: bold;">এই ক্যাটাগরিতে কোনো ভিডিও নেই।</p>'; return; }
            const isUnlocked = isGloballyUnlocked();
            data.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));
            data.forEach(v => {
                if (!v || !v.title) return;
                const card = document.createElement("div"); card.className = "card";
                const unlocked = getState(v.link).unlockedUntil > 0 || isUnlocked;
                card.innerHTML = `<div class="card-image-wrapper"><img src="${v.img}" alt="${v.title}" loading="lazy"></div><div class="card-title">${v.title}</div><div class="card-body"><div class="card-desc"><span class="upload-time-span" data-upload-time="${v.uploadTime}">আপলোড: ${timeAgo(v.uploadTime)}</span><span>ভিউ: ${(Math.floor(Math.random()*85)+5)/10}K</span></div>${unlocked ? `<button class="watch-btn" onclick="watchVideo('${v.link}')">Watch Now</button>` : `<button class="unlock-btn" onclick="unlockVideo('${encodeURIComponent(v.link)}')">🔓 Unlock Video</button>`}</div>`;
                listDiv.appendChild(card);
            });
            updateAllCardTimes();
        }

        function renderList(category, page = 1) {
            let allDataRaw = (category === "All") ? [].concat(...Object.values(allVideosData)) : (allVideosData[category] || []);
            // শুধুমাত্র বৈধ ভিডিও (যাদের টাইটেল আছে) ফিল্টার করুন
            const allData = allDataRaw.filter(v => v && v.title);
            allData.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));
            // ফিল্টার করা ভিডিওর সংখ্যার উপর ভিত্তি করে মোট পেজ গণনা করুন
            const totalPages = Math.ceil(allData.length / VIDEOS_PER_PAGE);
            renderGrid(allData.slice((page - 1) * VIDEOS_PER_PAGE, page * VIDEOS_PER_PAGE));
            renderPagination(totalPages, currentPage);
        }

        function renderPagination(totalPages, currentPage) {
            const pDiv = document.getElementById("pagination"), pFoot = document.getElementById('paginationFooterText');
            pDiv.innerHTML = "";
            pFoot.innerText = ""; // ডিফল্টভাবে ফুটার টেক্সট খালি করুন

            if (totalPages <= 1) {
                return; // যদি ১ বা তার কম পেজ থাকে তবে কিছুই দেখাবেন না
            }
            
            const createBtn = (text, page) => { const btn = document.createElement("button"); btn.className = "page-btn"; btn.innerText = text; btn.onclick = () => switchTab(activeCategory, page); return btn; };
            
            if (currentPage > 1) {
                pDiv.appendChild(createBtn("পেছনে", currentPage - 1));
            }
            
            const activeBtn = createBtn(currentPage, currentPage); 
            activeBtn.classList.add("active"); 
            pDiv.appendChild(activeBtn);
            
            if (currentPage < totalPages) {
                pDiv.appendChild(createBtn("পরের পেজ", currentPage + 1));
                pFoot.innerText = "➡️ আরও ভিডিও দেখতে পরের পেজে যান।"; // শুধুমাত্র যদি পরের পেজ থাকে তবেই টেক্সট দেখান
            }
        }

        async function unlockVideo(encodedLink) {
            const link = decodeURIComponent(encodedLink);
            if (getState(link).unlockedUntil > 0 || isGloballyUnlocked()) { 
                watchVideo(link); 
                return; 
            }
            
            const adSuccess = await showAd(); // Wait for ad to complete
            if (adSuccess) {
                setState(link, { unlockedUntil: Date.now() + UNLOCK_DURATION });
                incrementDailyCount();
                const searchVal = document.getElementById('searchInput').value;
                if (searchVal.trim()) handleSearch({ target: { value: searchVal } }); 
                else switchTab(activeCategory, currentPage);
            } else {
                // If ad was not successful (e.g., closed prematurely, blocked), show a generic message or no message
                alert("ভিডিও আনলক করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।"); // আপনি চাইলে এই মেসেজটিও মুছে দিতে পারেন।
            }
        }

        const watchVideo = (link) => {
            if (getState(link).unlockedUntil > 0 || isGloballyUnlocked()) {
                window.open(link, '_blank');
            } else {
                alert("ভিডিও দেখার জন্য প্রথমে আনলক করুন।");
            }
        };
        
        function updateProgressBar() {
            const fill = document.getElementById('progressBarFill'), text = document.getElementById('progressBarText');
            const { count } = getDailyCount(), progress = Math.min((count / DAILY_UNLOCK_LIMIT) * 100, 100);
            if (isGloballyUnlocked()) {
                text.innerText = `সকল ভিডিও ২৪ ঘন্টার জন্য আনলকড`;
                fill.style.width = `100%`;
            } else {
                const remainingPercentage = 100 - Math.round(progress);
                text.innerText = `সকল ভিডিও আনলক হতে বাকি ${remainingPercentage}%`;
                fill.style.width = `${progress}%`;
            }
        }
    </script>
</body>
</html>
